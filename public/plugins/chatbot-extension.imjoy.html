<docs>
[TODO: write documentation for this plugin.]
</docs>

<config lang="json">
{
  "name": "chatbot-ufish",
  "type": "web-worker",
  "tags": [],
  "ui": "",
  "version": "0.1.0",
  "cover": "",
  "description": "Register ufish-web to chatbot",
  "icon": "extension",
  "inputs": null,
  "outputs": null,
  "api_version": "0.1.8",
  "env": "",
  "permissions": [],
  "requirements": [],
  "dependencies": []
}
</config>

<script lang="javascript">
const chatbot_url = "https://bioimage.io/chat/"
//const ufish_url = "https://ufish-team.github.io/"
const ufish_url = "http://localhost:5173/"
const utils_url = ufish_url + "/plugins/chatbot-utils.imjoy.html"
const dna_utils_url = ufish_url + "/plugins/dna-ufish-utils.imjoy.html"
const py_console_url = "https://nanguage.github.io/web-python-console/"

class ImJoyPlugin {
  async setup() {
    if (api.registerChatbotExtension) {
      const chatbot = api
      await this.registerExtensions(chatbot.registerChatbotExtension)
    } else {
      let chatbot = await api.getWindow("BioImage.IO Chatbot")
      if (chatbot) {
        await this.registerExtensions(chatbot.registerExtension)
      } else {
        chatbot = await api.createWindow({
          src: chatbot_url, name: "BioImage.IO Chatbot",
          w: 20, h: 40
        })
        await this.registerExtensions(chatbot.registerExtension)
      }
    }
    await this.getUfishClient()
    await this.getChatbotUtils()
    await this.getDnaUtils()
    this.annotation_layer = null
    this.ufish_spots = null
  }

  async getUfishClient() {
    let client = await api.getWindow("ufish");
    if (!client) {
      client = await api.createWindow({
        src: ufish_url,
        name: "ufish",
        w: 25, h: 6
      });
    }
    client.setExampleImageUrl(ufish_url + "images/test_fish_img2.jpg")
    return client
  }

  async getChatbotUtils() {
    let plugin;
    try {
      plugin = await api.getPlugin("ufish-chatbot-utils")
    } catch (e) {
      plugin = await api.loadPlugin({src: utils_url, name: "ufish-chatbot-utils"})
    }
    return plugin
  }

  async getDnaUtils() {
    let plugin;
    try {
      plugin = await api.getPlugin("dna-ufish-utils")
    } catch (e) {
      plugin = await api.loadPlugin({src: dna_utils_url, name: "dna-ufish-utils"})
    }
    return plugin
  }

  async getPythonConsole() {
    let plugin = await api.getWindow("web-python-console");
    if (!plugin) {
      plugin = await api.createWindow({
        src: py_console_url,
        name: "web-python-console",
        w: 25, h: 30
      });
    }
    return plugin
  }
    
  async registerExtensions(register) {
    // Extension allow chatbot run U-FISH web client
    await register({
      _rintf: true,
      name: "runUfish",
      description: "The extension allow chatbot run U-FISH web client",
      get_schema: async () => {
        return {
          type: "object",
          title: "RunUfish",
          description: "Run U-FISH web client to detect spots in the image",
          properties: {
            "channel": {
              type: "number | null",
              description: "Channel to use",
              default: null,
            },
            "pThreshold": {
              type: "number",
              description: "Threshold for spot detection",
              default: 0.5,
            },
            "viewEnhanced": {
              type: "boolean",
              description: "View enhanced image",
              default: false,
            },
          }
        }
      },
      execute: async (config) => {
        const client = await this.getUfishClient()
        await client.waitReady();
        await client.runPredict(config.channel, config.pThreshold, false, config.viewEnhanced);
        const output = await client.getOutput();
        this.ufish_spots = output.spots
        return "Done"
      },
    })

    // Extension allow chatbot run cellpose model
    await register({
      _rintf: true,
      name: "runCellpose",
      description: "The extension allow chatbot run cellpose model",
      get_schema: async () => {
        return {
          type: "object",
          title: "RunCellpose",
          description: "Run cellpose model",
          properties: {
            "diameter": {
              type: "number",
              description: "Diameter of the cells",
              default: 50,
            },
            "model_type": {
              type: "string",
              description: "Model type, nuclei or cyto",
              default: "nuclei",
            },
            "flow_threshold": {
              type: "number",
              description: "Flow threshold",
              default: 0.4,
            },
            "channel": {
              type: "number",
              description: "Channel to use",
              default: 2,
            }
          },
        };
      },
      execute: async (config) => {
        const client = await this.getUfishClient()
        const utils = await this.getChatbotUtils()
        const img = await client.getInputImage()
        await utils.run_cellpose(
          img,
          config.channel,
          {
            diameter: config.diameter,
            model_type: config.model_type,
            flow_threshold: config.flow_threshold,
          }
        )
        await utils.compute_mask_coutours()
        const coutours = await utils.get_coutours()
        const kaibu = await api.getWindow("Kaibu")
        const annotation_layer = await kaibu.add_shapes([], {name: 'cellpose-segmentation'})
        this.annotation_layer = annotation_layer
        for (let i = 0; i < coutours.length; i++) {
          const coords = coutours[i]
          const polygon = {
            type: "Feature",
            coordinates: [coords],
            geometry: {
                type: "Polygon",
                coordinates: [coords],
            },
            properties: {
                edgecolor: "#FF0000",
                edge_width: 2,
                face_color: "#FF00000F",
                size: 7,
            },
          }
          annotation_layer.add_feature(polygon)
        }
        return "Done"
      },
    })

    const pycodeDescription = `
    The extension allow chatbot execute Python code in Pyodide environment.

    Code reference:
      + The \`api\` is the ImJoy API object, it's a global variable in the Pyodide environment.
      + Get the spots (numpy array) of U-FISH result:
        \`\`\`
        ufish = await api.getWindow("ufish")
        spots = (await ufish.getOutput())['spots']
        \`\`\`
      + Get the input image (numpy array) of U-FISH:
        \`\`\`
        ufish = await api.getWindow("ufish")
        input_img = await ufish.getInputImage()
        \`\`\`
      + Get the enhanced image (numpy array) of U-FISH:
        \`\`\`
        ufish = await api.getWindow("ufish")
        enhanced_img = (await ufish.getOutput())['enhanced']
        \`\`\`
`

    // Extension allow execute Python code
    await register(({
      _rintf: true,
      name: "runPythonCode",
      description: "The extension allow chatbot execute Python code in Pyodide environment",
      get_schema: async () => {
        return {
          type: "object",
          title: "runPythonCode",
          description: pycodeDescription,
          properties: {
            "code": {
              type: "string",
              description: "Python code to execute",
              default: "print('Hello World')",
            },
          },
        };
      },
      execute: async (config) => {
        const console = await this.getPythonConsole()
        await console.exec(config.code)
        const console_content = await console.get_content()
        return console_content
      },
    }))

    // Extension allow count spots in cells
    await register({
      _rintf: true,
      name: "countSpotsInCells",
      description: "The extension allow chatbot count spots in cells",
      get_schema: async () => {
        return {
          type: "object",
          title: "countSpotsInCells",
          description: "Count spots in cells",
          properties: {
            "use_selected": {
              type: "boolean",
              description: "Use selected cells",
              default: false,
            },
          },
        };
      },
      execute: async (config) => {
        const spots = this.ufish_spots
        if (!spots) {
          return "Please run U-FISH first"
        }
        const anno_layer = this.annotation_layer
        if (!anno_layer) {
          return "Please run cellpose first"
        }
        const utils = await this.getChatbotUtils()
        const client = await this.getUfishClient()
        const img = await client.getInputImage()
        if (!img) {
          return "Please open an image first"
        }
        const img_shape = img._rshape
        let cell_features;
        if (config.use_selected) {
          cell_features = await anno_layer.get_selected_features()
        } else {
          cell_features = await anno_layer.get_features()
        }
        const spots_in_cells = await utils.count_spots_in_cells(
          spots, img_shape, cell_features)
        return "Number of spots in cells: " + spots_in_cells
      },
    })

    await register({
      _rintf: true,
      name: "analysisDnaFish",
      description: "Analysis DNA-FISH data using U-FISH.",
      get_schema: async () => {
        return {
          type: "object",
          title: "analysisDnaFish",
          description: "Analysis DNA-FISH data using U-FISH.",
          properties: {
            "cell_diameter": {
              type: "number",
              description: "Diameter of the cells",
              default: 40,
            },
            "signal_channels": {
              type: "string",
              description: "Signal channels",
              default: "[0, 1]",
            }
          }
        }
      },
      execute: async (config) => {
        const client = await this.getUfishClient()
        const dna_utils = await this.getDnaUtils()
        const utils = await this.getChatbotUtils()
        const img = await client.getInputImage()
        await utils.run_cellpose(
          img,
          2,
          {
            diameter: config.cell_diameter,
            model_type: "nuclei",
            flow_threshold: 0.4,
          }
        )
        const mask = await utils.get_mask()
        const signal_channels = eval(config.signal_channels)
        console.log("Signal channels:", signal_channels)
        const analysis_summary = await dna_utils.analysis(img, mask, signal_channels)
        await client.setInputImage(img)
        return analysis_summary
      },
    })

    await register({
      _rintf: true,
      name: "drawDnaFishExamples",
      description: "Draw results of DNA-FISH analysis.",
      get_schema: async () => {
        return {
          type: "object",
          title: "drawDnaFishExamples",
          description: "Draw results of DNA-FISH analysis.",
          properties: {
            "max_plots": {
              type: "number",
              description: "Max number of cells to plot",
              default: 50,
            },
          }
        }
      },
      execute: async (config) => {
        const dna_utils = await this.getDnaUtils()
        const arr = await dna_utils.draw_sample_results(config.max_plots)
        const kaibu = await api.getWindow("Kaibu")
        kaibu.view_image(
          arr,
          {
            name: "DNA-FISH analysis",
          }
        )
        return "Done"
      }
    })    

    api.log('initialized')
  }
  async run(ctx) { }
}

api.export(new ImJoyPlugin())
</script>
